generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Property {
  id                  String               @id @default(cuid())
  name                String
  timezone            String               @default("Europe/London")
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  subscriptionActive  Boolean              @default(true)
  subscriptionStatus  SubscriptionStatus   @default(TRIALING)
  trialEndsAt         DateTime?
  trialStartsAt       DateTime             @default(now())
  targetFoodCostPct   Int?
  inviteAudits        InviteAudit[]
  monthlyFoodCosts    MonthlyFoodCost[]
  procurementRequests ProcurementRequest[]
  invites             PropertyInvite[]
  memberships         PropertyMembership[]
  settings            PropertySettings?
  refrigerationUnits  RefrigerationUnit[]
  rotaShifts          RotaShift[]
  rotaWeeks           RotaWeek[]
  temperatureLogs     TemperatureLog[]
}

model PropertySettings {
  id                     String   @id @default(cuid())
  propertyId             String   @unique
  fridgeMinTenthC        Int      @default(10)
  fridgeMaxTenthC        Int      @default(50)
  freezerMinTenthC       Int      @default(-250)
  freezerMaxTenthC       Int      @default(-150)
  foodCostTargetBps      Int      @default(3000)
  cookedMinTenthC        Int      @default(750)
  reheatedMinTenthC      Int      @default(750)
  chilledMinTenthC       Int      @default(0)
  chilledMaxTenthC       Int      @default(50)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  blastChillMaxMinutes   Int      @default(90)
  blastChillTargetTenthC Int      @default(50)
  property               Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
}

model TeamHandover {
  id           String             @id @default(cuid())
  propertyId   String
  authorId     String
  message      String
  handoverDate DateTime
  createdAt    DateTime           @default(now())
  author       User               @relation("TeamHandoverAuthor", fields: [authorId], references: [id])
  reads        TeamHandoverRead[]

  @@index([propertyId, handoverDate])
  @@index([propertyId, createdAt])
}

model TeamHandoverRead {
  id         String       @id @default(cuid())
  handoverId String
  readerId   String
  readAt     DateTime     @default(now())
  handover   TeamHandover @relation(fields: [handoverId], references: [id], onDelete: Cascade)
  reader     User         @relation("TeamHandoverReader", fields: [readerId], references: [id])

  @@unique([handoverId, readerId])
  @@index([readerId, readAt])
}

model eventFoodTemperatureLog {
  id              String         @id @default(cuid())
  propertyId      String
  eventName       String
  eventDate       DateTime
  eventId         String?
  loggedAt        DateTime       @default(now())
  logDate         DateTime
  period          LogPeriod?
  status          FoodTempStatus @default(OK)
  foodName        String
  tempC           Decimal?       @db.Decimal(5, 2)
  notes           String?
  createdByUserId String?

  @@index([propertyId, eventDate])
  @@index([propertyId, eventId, eventDate])
}

model User {
  id                           String                  @id @default(cuid())
  name                         String?
  email                        String                  @unique
  passwordHash                 String
  createdAt                    DateTime                @default(now())
  updatedAt                    DateTime                @updatedAt
  inviteAudits                 InviteAudit[]
  maintenanceCompletions       MaintenanceCompletion[] @relation("MaintenanceCompletedByAdmin")
  maintenanceReads             MaintenanceRead[]       @relation("MaintenanceReadByAdmin")
  maintenanceReported          MaintenanceRequest[]    @relation("MaintenanceReportedBy")
  passwordResetTokens          PasswordResetToken[]
  procurementRequestsDecided   ProcurementRequest[]    @relation("ProcurementDecidedBy")
  procurementRequestsRequested ProcurementRequest[]    @relation("ProcurementRequestedBy")
  createdInvites               PropertyInvite[]
  memberships                  PropertyMembership[]
  rotaShifts                   RotaShift[]
  publishedRotaWeeks           RotaWeek[]              @relation("RotaWeekPublishedBy")
  teamHandoversAuthored        TeamHandover[]          @relation("TeamHandoverAuthor")
  teamHandoversRead            TeamHandoverRead[]      @relation("TeamHandoverReader")
  temperatureLogs              TemperatureLog[]        @relation("UserTemperatureLogs")
}

model PropertyMembership {
  id         String         @id @default(cuid())
  role       MembershipRole @default(PROPERTY_USER)
  isActive   Boolean        @default(true)
  propertyId String
  userId     String
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  property   Property       @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([propertyId, userId])
  @@index([propertyId])
  @@index([userId])
}

model PropertyInvite {
  id          String         @id @default(cuid())
  propertyId  String
  email       String
  role        MembershipRole @default(PROPERTY_USER)
  tokenHash   String         @unique
  expiresAt   DateTime
  usedAt      DateTime?
  createdById String?
  createdAt   DateTime       @default(now())
  publicToken String?        @unique
  audits      InviteAudit[]
  createdBy   User?          @relation(fields: [createdById], references: [id])
  property    Property       @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([email])
}

model RefrigerationUnit {
  id         String            @id @default(cuid())
  propertyId String
  name       String
  type       RefrigerationType @default(FRIDGE)
  isActive   Boolean           @default(true)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  property   Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  logs       TemperatureLog[]

  @@unique([propertyId, name])
  @@index([propertyId])
}

model TemperatureLog {
  id          String            @id @default(cuid())
  propertyId  String
  unitId      String
  valueC      Decimal?          @db.Decimal(5, 2)
  period      LogPeriod         @default(OTHER)
  notes       String?
  loggedAt    DateTime          @default(now())
  createdById String
  status      TemperatureStatus @default(NORMAL)
  createdBy   User              @relation("UserTemperatureLogs", fields: [createdById], references: [id], onDelete: Cascade)
  property    Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit        RefrigerationUnit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([propertyId, loggedAt])
  @@index([unitId, loggedAt])
  @@index([createdById, loggedAt])
}

/// *
///  * =========================
///  * Maintenance
///  * =========================
model MaintenanceRequest {
  id           String                 @id @default(cuid())
  propertyId   String
  reportedById String
  title        String
  details      String?
  location     String?
  equipment    String?
  urgency      MaintenanceUrgency     @default(WEEK)
  createdAt    DateTime               @default(now())
  completed    MaintenanceCompletion?
  read         MaintenanceRead?
  reportedBy   User                   @relation("MaintenanceReportedBy", fields: [reportedById], references: [id])

  @@index([propertyId, createdAt])
  @@index([propertyId, urgency])
}

model MaintenanceRead {
  id        String             @id @default(cuid())
  requestId String             @unique
  adminId   String
  readAt    DateTime           @default(now())
  admin     User               @relation("MaintenanceReadByAdmin", fields: [adminId], references: [id])
  request   MaintenanceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([adminId, readAt])
}

model MaintenanceCompletion {
  id          String             @id @default(cuid())
  requestId   String             @unique
  adminId     String
  completedAt DateTime           @default(now())
  admin       User               @relation("MaintenanceCompletedByAdmin", fields: [adminId], references: [id])
  request     MaintenanceRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([adminId, completedAt])
}

model RotaWeek {
  id            String      @id @default(cuid())
  propertyId    String
  weekStart     DateTime
  notes         String?
  published     Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  isPublished   Boolean     @default(false)
  publishedAt   DateTime?
  publishedById String?
  shifts        RotaShift[]
  property      Property    @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  publishedBy   User?       @relation("RotaWeekPublishedBy", fields: [publishedById], references: [id])

  @@unique([propertyId, weekStart])
  @@index([propertyId, weekStart])
}

model RotaShift {
  id         String    @id @default(cuid())
  propertyId String
  weekId     String
  userId     String?
  dayIndex   Int
  startTime  String
  endTime    String
  role       ShiftRole @default(OTHER)
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  property   Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user       User?     @relation(fields: [userId], references: [id])
  week       RotaWeek  @relation(fields: [weekId], references: [id], onDelete: Cascade)

  @@index([propertyId, weekId])
  @@index([propertyId, dayIndex])
  @@index([userId])
}

model foodTemperatureLog {
  id              String         @id @default(cuid())
  propertyId      String
  loggedAt        DateTime       @default(now())
  logDate         DateTime
  period          LogPeriod?
  status          FoodTempStatus @default(OK)
  foodName        String
  tempC           Decimal?       @db.Decimal(5, 2)
  notes           String?
  eventId         String?
  createdByUserId String?

  @@index([propertyId, logDate])
  @@index([propertyId, eventId, logDate])
}

model ProcurementRequest {
  id             String                      @id @default(cuid())
  propertyId     String
  category       ProcurementCategory         @default(FOOD)
  status         ProcurementStatus           @default(REQUESTED)
  itemName       String
  quantity       Decimal?                    @db.Decimal(10, 2)
  unit           String?
  neededBy       DateTime?
  notes          String?
  requestedById  String
  decidedById    String?
  decidedAt      DateTime?
  rejectedReason ProcurementRejectionReason?
  rejectedNote   String?
  deliveredAt    DateTime?
  createdAt      DateTime                    @default(now())
  updatedAt      DateTime                    @updatedAt
  decidedBy      User?                       @relation("ProcurementDecidedBy", fields: [decidedById], references: [id])
  property       Property                    @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  requestedBy    User                        @relation("ProcurementRequestedBy", fields: [requestedById], references: [id], onDelete: Cascade)

  @@index([propertyId, category, status, createdAt])
  @@index([propertyId, status, neededBy])
  @@index([requestedById, createdAt])
  @@index([decidedById, decidedAt])
}

model MonthlyFoodCost {
  id                 String   @id @default(cuid())
  propertyId         String
  monthStart         DateTime
  foodPurchasesPence Int      @default(0)
  foodSalesPence     Int      @default(0)
  creditsPence       Int      @default(0)
  openingStockPence  Int      @default(0)
  closingStockPence  Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  property           Property @relation(fields: [propertyId], references: [id])

  @@unique([propertyId, monthStart])
  @@index([propertyId, monthStart])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model InviteAudit {
  id          String            @id @default(cuid())
  propertyId  String
  inviteId    String
  action      InviteAuditAction
  actorUserId String?
  note        String?
  createdAt   DateTime          @default(now())
  actor       User?             @relation(fields: [actorUserId], references: [id])
  invite      PropertyInvite    @relation(fields: [inviteId], references: [id], onDelete: Cascade)
  property    Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId, createdAt])
  @@index([inviteId, createdAt])
  @@index([actorUserId, createdAt])
}

enum MembershipRole {
  PROPERTY_ADMIN
  PROPERTY_USER
}

enum RefrigerationType {
  FRIDGE
  FREEZER
}

enum LogPeriod {
  AM
  PM
  OTHER
}

enum TemperatureStatus {
  NORMAL
  DEFROST
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
}

enum ShiftRole {
  CHEF
  SOUS_CHEF
  CDP
  COMMIS
  KP
  OTHER
}

enum InviteAuditAction {
  CREATED
  REVOKED
  ACCEPTED
}

enum ProcurementCategory {
  FOOD
  SUPPLIES
}

enum ProcurementStatus {
  REQUESTED
  ORDERED
  REJECTED
  DELIVERED
  CANCELED
}

enum ProcurementRejectionReason {
  MENU_CHANGE
  OUT_OF_SEASON
  SUPPLIER_OUT_OF_STOCK
  ALREADY_IN_STOCK
  BUDGET_COST_CONTROL
  NOT_APPROVED
  OTHER
}

enum MaintenanceUrgency {
  H24
  H48
  WEEK
}

enum FoodTempStatus {
  OK
  OUT_OF_RANGE
  DISCARDED
  REHEATED
  COOLED
}
